_N_E=(window.webpackJsonp_N_E=window.webpackJsonp_N_E||[]).push([[19],{XfAq:function(e,s,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/options/middleware",function(){return n("zeQQ")}])},YFqc:function(e,s,n){e.exports=n("cTJO")},cTJO:function(e,s,n){"use strict";var t=n("J4zp"),r=n("284h");s.__esModule=!0,s.default=void 0;var c=r(n("q1tI")),a=n("elyg"),o=n("nOHt"),i=n("vNVm"),l={};function d(e,s,n,t){if((0,a.isLocalURL)(s)){e.prefetch(s,n,t).catch((function(e){0}));var r=t&&"undefined"!==typeof t.locale?t.locale:e&&e.locale;l[s+"%"+n+(r?"%"+r:"")]=!0}}var u=function(e){var s=!1!==e.prefetch,n=(0,o.useRouter)(),r=n&&n.pathname||"/",u=c.default.useMemo((function(){var s=(0,a.resolveHref)(r,e.href,!0),n=t(s,2),c=n[0],o=n[1];return{href:c,as:e.as?(0,a.resolveHref)(r,e.as):o||c}}),[r,e.href,e.as]),h=u.href,j=u.as,p=e.children,b=e.replace,f=e.shallow,x=e.scroll,m=e.locale;"string"===typeof p&&(p=c.default.createElement("a",null,p));var g=c.Children.only(p),O=g&&"object"===typeof g&&g.ref,y=(0,i.useIntersection)({rootMargin:"200px"}),w=t(y,2),v=w[0],N=w[1],q=c.default.useCallback((function(e){v(e),O&&("function"===typeof O?O(e):"object"===typeof O&&(O.current=e))}),[O,v]);(0,c.useEffect)((function(){var e=N&&s&&(0,a.isLocalURL)(h),t="undefined"!==typeof m?m:n&&n.locale,r=l[h+"%"+j+(t?"%"+t:"")];e&&!r&&d(n,h,j,{locale:t})}),[j,h,N,m,s,n]);var M={ref:q,onClick:function(e){g.props&&"function"===typeof g.props.onClick&&g.props.onClick(e),e.defaultPrevented||function(e,s,n,t,r,c,o,i){("A"!==e.currentTarget.nodeName||!function(e){var s=e.currentTarget.target;return s&&"_self"!==s||e.metaKey||e.ctrlKey||e.shiftKey||e.altKey||e.nativeEvent&&2===e.nativeEvent.which}(e)&&(0,a.isLocalURL)(n))&&(e.preventDefault(),null==o&&(o=t.indexOf("#")<0),s[r?"replace":"push"](n,t,{shallow:c,locale:i}).then((function(e){e&&o&&(window.scrollTo(0,0),document.body.focus())})))}(e,n,h,j,b,f,x,m)},onMouseEnter:function(e){(0,a.isLocalURL)(h)&&(g.props&&"function"===typeof g.props.onMouseEnter&&g.props.onMouseEnter(e),d(n,h,j,{priority:!0}))}};return(e.passHref||"a"===g.type&&!("href"in g.props))&&(M.href=(0,a.addBasePath)((0,a.addLocale)(j,"undefined"!==typeof m?m:n&&n.locale,n&&n.defaultLocale))),c.default.cloneElement(g,M)};s.default=u},vNVm:function(e,s,n){"use strict";var t=n("J4zp"),r=n("TqRt");s.__esModule=!0,s.useIntersection=function(e){var s=e.rootMargin,n=e.disabled||!o,r=(0,c.useRef)(),l=(0,c.useState)(!1),d=t(l,2),u=d[0],h=d[1],j=(0,c.useCallback)((function(e){r.current&&(r.current(),r.current=void 0),n||u||e&&e.tagName&&(r.current=function(e,s,n){var t=function(e){var s=e.rootMargin||"",n=i.get(s);if(n)return n;var t=new Map,r=new IntersectionObserver((function(e){e.forEach((function(e){var s=t.get(e.target),n=e.isIntersecting||e.intersectionRatio>0;s&&n&&s(n)}))}),e);return i.set(s,n={id:s,observer:r,elements:t}),n}(n),r=t.id,c=t.observer,a=t.elements;return a.set(e,s),c.observe(e),function(){c.unobserve(e),0===a.size&&(c.disconnect(),i.delete(r))}}(e,(function(e){return e&&h(e)}),{rootMargin:s}))}),[n,s,u]);return(0,c.useEffect)((function(){o||u||(0,a.default)((function(){return h(!0)}))}),[u]),[j,u]};var c=n("q1tI"),a=r(n("0G5g")),o="undefined"!==typeof IntersectionObserver;var i=new Map},zeQQ:function(e,s,n){"use strict";n.r(s),n.d(s,"default",(function(){return a}));var t=n("nKUr"),r=n("YFqc"),c=n.n(r);function a(){return Object(t.jsxs)(t.Fragment,{children:[Object(t.jsx)("div",{className:"jumbotron",children:Object(t.jsx)("div",{className:"container",children:Object(t.jsx)("div",{className:"row",children:Object(t.jsxs)("div",{className:"col-lg-8 offset-lg-2",children:[Object(t.jsx)("h1",{className:"display-4",children:"Global and Specific Middleware"}),Object(t.jsx)("p",{className:"lead",children:Object(t.jsx)(c.a,{href:"/options",children:Object(t.jsx)("a",{children:"\u2190 Back to all options"})})})]})})})}),Object(t.jsx)("main",{className:"container",children:Object(t.jsx)("div",{className:"row",children:Object(t.jsxs)("div",{className:"col-lg-8 offset-lg-2",children:[Object(t.jsxs)("p",{children:["With GraphQL Firebase, you have middlewares galore. Let\u2019s start with the ",Object(t.jsx)("code",{children:"globalMiddleware"})," option."]}),Object(t.jsxs)("h2",{children:["Using ",Object(t.jsx)("code",{children:"globalMiddleware"})]}),Object(t.jsxs)("p",{children:["With this option, you can add any"," ",Object(t.jsx)("a",{href:"https://expressjs.com/en/guide/using-middleware.html",children:"Express middleware"})," ","to your GraphQL Firebase. Adding middleware here will apply to"," ",Object(t.jsx)("em",{children:"all"})," of your endpoints. This might be a good place to, for example, add some analytics if you want to log every request that comes no matter what the request is (graphql, mockql, playground, voyager - whatever)."]}),Object(t.jsxs)("p",{children:["You can pass a single middleware function, or an array of functions. If passing an array, your ",Object(t.jsx)("code",{children:"globalMiddleware"})," ","will run in order before any other middleware and before any of the GraphQL Firebase responses are handled."]}),Object(t.jsx)("pre",{className:"bg-light p-3",children:Object(t.jsxs)("code",{children:[Object(t.jsxs)("span",{className:"text-muted",children:["// We use ES6+ and typescript in our projects,",Object(t.jsx)("br",{}),"// but you can adjust this to use commonjs"]}),Object(t.jsx)("br",{}),Object(t.jsx)("br",{}),'import * as functions from "firebase-functions"\n\nimport { GraphQLFirebase } from "@undefinedai/graphql-firebase"\n\nconst loggingMiddleware = (req: express.Request, res: express.Response, next: express.NextFunction) => {\n  console.log("Time:", Date.now())\n  next()\n}\n\nexport const graphql = functions.https.onRequest(GraphQLFirebase({ \n  globalMiddleware: loggingMiddleware\n}))']})}),Object(t.jsx)("h2",{children:"Using Path-Specific Middleware"}),Object(t.jsx)("p",{children:'For each "path" created by GraphQL Firebase, you can pass any custom middleware and have it applied just to that path. With everything enabled, GraphQL Firebase has the following middleware options for the following paths:'}),Object(t.jsxs)("dl",{className:"row",children:[Object(t.jsx)("dt",{className:"col-md-5 col-xl-4",children:Object(t.jsx)("code",{children:"dashboardMiddleware"})}),Object(t.jsx)("dd",{className:"col-md-7 col-xl-8",children:"Runs just before a user accesses the dashboard page"}),Object(t.jsx)("dt",{className:"col-md-5 col-xl-4",children:Object(t.jsx)("code",{children:"fourOhFourMiddleware"})}),Object(t.jsx)("dd",{className:"col-md-7 col-xl-8",children:"Runs just before serving up the GraphQL Firebase 404 page"}),Object(t.jsx)("dt",{className:"col-md-5 col-xl-4",children:Object(t.jsx)("code",{children:"graphMiddleware"})}),Object(t.jsxs)("dd",{className:"col-md-7 col-xl-8",children:["Runs just before processing any requests to the"," ",Object(t.jsx)("code",{children:"graphql"})," endpoint"]}),Object(t.jsx)("dt",{className:"col-md-5 col-xl-4",children:Object(t.jsx)("code",{children:"graphPlaygroundMiddleware"})}),Object(t.jsx)("dd",{className:"col-md-7 col-xl-8",children:"Runs just before a user accesses the GraphQL Playground"}),Object(t.jsx)("dt",{className:"col-md-5 col-xl-4",children:Object(t.jsx)("code",{children:"mockMiddleware"})}),Object(t.jsxs)("dd",{className:"col-md-7 col-xl-8",children:["Runs just before processing any requests to the"," ",Object(t.jsx)("code",{children:"mockql"})," endpoint"]}),Object(t.jsx)("dt",{className:"col-md-5 col-xl-4",children:Object(t.jsx)("code",{children:"mockPlaygroundMiddleware"})}),Object(t.jsx)("dd",{className:"col-md-7 col-xl-8",children:"Runs just before a user accesses the MockQL Playground"}),Object(t.jsx)("dt",{className:"col-md-5 col-xl-4",children:Object(t.jsx)("code",{children:"voyagerMiddleware"})}),Object(t.jsx)("dd",{className:"col-md-7 col-xl-8",children:"Runs just before a user accesses the GraphQL Voyager"})]}),Object(t.jsx)("h3",{id:"verify-request-headers",children:"Example: Verifying Headers For Requests"}),Object(t.jsxs)("p",{children:["Let\u2019s say you use Firebase Authentication in your app and you want to verify a user\u2019s"," ",Object(t.jsx)("a",{href:"https://firebase.google.com/docs/auth/admin/verify-id-tokens",children:"Firebase ID Token"})," ","as a way of authenticating graphql requests so that other apps can\u2019t use your api. Your app passes the ",Object(t.jsx)("code",{children:"idToken"})," ","as a header named ",Object(t.jsx)("code",{children:"X-Token"}),". We\u2019re going to apply this same requirement to the graphql and mockql endpoints:"]}),Object(t.jsx)("pre",{className:"bg-light p-3",children:Object(t.jsxs)("code",{children:[Object(t.jsxs)("span",{className:"text-muted",children:["// We use ES6+ and typescript in our projects,",Object(t.jsx)("br",{}),"// but you can adjust this to use commonjs"]}),Object(t.jsx)("br",{}),Object(t.jsx)("br",{}),'import * as functions from "firebase-functions"\nimport * as admin from "firebase-admin"\n\nimport { GraphQLFirebase } from "@undefinedai/graphql-firebase"\n\nconst authMiddleware = async (req: express.Request, res: express.Response, next: express.NextFunction) => {\n  const idToken = req.get("X-Token") || "badToken"\n  try {\n    await admin.auth().verifyIdToken(idToken)\n    next()\n  } catch (error) {\n    res.json({\n      error: {\n        errors: [\n          {\n            code: 401,\n            message: "The credentials you supplied could not be verified.",\n          },\n        ],\n      },\n    })\n    res.end()\n  }\n}\n\nexport const graphql = functions.https.onRequest(GraphQLFirebase({ \n  graphMiddleware: authMiddleware,\n  mockMiddleware: authMiddleware\n}))']})}),Object(t.jsx)("p",{children:"Notice two key things here:"}),Object(t.jsxs)("ol",{children:[Object(t.jsxs)("li",{children:["Middleware functions can return promises and use"," ",Object(t.jsxs)("code",{children:["async",Object(t.jsx)("span",{className:"text-muted",children:"/"}),"await"]}),"."]}),Object(t.jsxs)("li",{children:["We\u2019re sending json back to be consumed by our app \u2013 this is not required. You can do whatever you like in the"," ",Object(t.jsx)("code",{children:"catch"})," block."]})]}),Object(t.jsxs)("p",{children:['You should also note that this middleware would essentially "break" your playgrounds and voyager because the playgrounds and voyager need to communicate with your endpoints. We say "break" in quotes because'," ",Object(t.jsx)(c.a,{href:"/options/headers",children:Object(t.jsx)("a",{children:'there\u2019s a "fix" for it'})}),"."]}),Object(t.jsx)("p",{children:Object(t.jsx)(c.a,{href:"/options",children:Object(t.jsx)("a",{children:"\u2190 Back to all options"})})})]})})})]})}}},[["XfAq",0,1,2]]]);